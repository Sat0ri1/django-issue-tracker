{% load i18n %}

<style>
.comments-toggle {
  display: none;
}

.comments-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}

.comments-toggle:checked ~ .comments-content {
  max-height: 1000px;
  transition: max-height 0.5s ease-in;
}

.comments-toggle:checked ~ .comments-content .comments-list {
  max-height: 300px;
  overflow-y: auto;
}

.chevron {
  transition: transform 0.3s ease;
  display: inline-block;
  width: 0;
  height: 0;
  border-left: 12px solid transparent;
  border-right: 12px solid transparent;
  border-top: 8px solid white;
  margin-left: 8px;
}

.comments-toggle:checked ~ label .chevron {
  transform: rotate(180deg);
}

.comments-header {
  padding: 1rem 1.5rem;
  margin: 0;
}

.comments-toggle:checked ~ .comments-header {
  border-bottom: 1px solid #4b5563;
  margin-bottom: 1.5rem;
}

.comments-body {
  padding: 0 1.5rem 1.5rem 1.5rem;
}

.comments-list {
  scrollbar-width: thin;
  scrollbar-color: #6b7280 #374151;
}

.comments-list::-webkit-scrollbar {
  width: 6px;
}

.comments-list::-webkit-scrollbar-track {
  background: #374151;
  border-radius: 3px;
}

.comments-list::-webkit-scrollbar-thumb {
  background: #6b7280;
  border-radius: 3px;
}
</style>

<div class="bg-gray-700 rounded-lg shadow-xl border border-gray-600 mt-6" id="comments-section-{{ issue.pk }}">
  <input type="checkbox" id="toggle-comments-{{ issue.pk }}" class="comments-toggle">
  <label for="toggle-comments-{{ issue.pk }}" class="comments-header flex justify-between items-center cursor-pointer">
    <h3 class="text-xl font-bold text-white">
      {% trans "Comments" %} (
        <span id="comment-count-{{ issue.pk }}">
          {% if comments %}{{ comments|length }}
          {% elif issue.comments_list %}{{ issue.comments_list|length }}
          {% else %}0{% endif %}
        </span>
      )
    </h3>
    <span class="chevron"></span>
  </label>

  <div class="comments-content">
    <div class="comments-body">
      <div class="comments-list space-y-4 mb-6" id="comments-list-{{ issue.pk }}">
        {% if comments %}
          {% for comment in comments %}
            {% include 'issues/_comment_item.html' with comment=comment %}
          {% endfor %}
        {% elif issue.comments_list %}
          {% for comment in issue.comments_list %}
            {% include 'issues/_comment_item.html' with comment=comment %}
          {% endfor %}
        {% else %}
          <div class="text-center py-8 text-gray-400" id="no-comments-{{ issue.pk }}">
            <p class="text-lg">{% trans "No comments" %}</p>
          </div>
        {% endif %}
      </div>

      {% if user.is_authenticated and user.role == 'assignee' or user.is_authenticated and user.role == 'admin' %}
      <form id="comment-form-{{ issue.pk }}"
            method="post"
            hx-post="{% url 'add_comment' issue_pk=issue.pk %}"
            hx-target="#comments-list-{{ issue.pk }}"
            hx-swap="beforeend"
            class="mt-6">
        {% csrf_token %}
        <div class="form-control">
          <label class="label">
            <span class="label-text text-white font-medium">{% trans "Add Comment" %}</span>
          </label>
          <textarea
            name="content"
            rows="3"
            class="textarea textarea-bordered w-full bg-gray-600 text-white border-gray-500 focus:border-gray-300 focus:ring-2 focus:ring-gray-300"
            placeholder="{% trans 'Write your comment...' %}"
            required></textarea>
        </div>
        <button type="submit" class="btn bg-gray-200 text-gray-700 border-none rounded-lg shadow-md hover:bg-gray-300 hover:shadow-lg mt-4">
          {% trans "Add Comment" %}
        </button>
      </form>
      {% else %}
        <div class="text-center py-4 text-gray-400">
          <p>{% trans "Only assignees and admins can add comments." %}</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
function updateCommentCount(issueId) {
  const countElement = document.getElementById(`comment-count-${issueId}`);
  const currentCount = parseInt(countElement.textContent);
  countElement.textContent = currentCount + 1;
}

function removeNoComments(issueId) {
  const noCommentsElement = document.getElementById(`no-comments-${issueId}`);
  if (noCommentsElement) {
    noCommentsElement.remove();
  }
}
</script>
