{% load i18n %}
{% load widget_tweaks %}

<div id="comments-section-{{ issue.pk }}" class="mt-8" data-testid="comments-section">
  <div class="bg-gray-700 rounded-lg shadow-xl p-6">
    <!-- Comments section header -->
    <h3 class="text-lg font-semibold text-white mb-5">
      {% blocktrans with count=issue.comments.count %}Comments ({{ count }}){% endblocktrans %}
    </h3>

    <!-- Comments list with scrolling -->
    <div id="comments-list-{{ issue.pk }}" 
         class="space-y-4 mb-6 max-h-[300px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800 pr-2" 
         data-testid="comments-list">
      {% for comment in issue.comments.all %}
        {% include "issues/_comment_item.html" %}
      {% empty %}
        <p class="text-gray-400 text-sm text-center" data-testid="no-comments">{% trans "No comments" %}</p>
      {% endfor %}
    </div>

    <!-- Comment form - ALWAYS VISIBLE -->
    {% if user.is_authenticated %}
      {% if user.role == "assignee" or user.role == "admin" %}
        {% trans "Write your comment..." as comment_ph %}
        <form 
          method="post" 
          action="{% url 'add_comment' issue_pk=issue.pk %}" 
          hx-post="{% url 'add_comment' issue_pk=issue.pk %}" 
          hx-target="#comments-section-{{ issue.pk }}" 
          hx-swap="outerHTML" 
          class="space-y-4" 
          data-testid="comment-form">
          {% csrf_token %}
          <div class="form-control">
            <textarea 
              name="text" 
              class="textarea textarea-bordered w-full bg-gray-600 text-white border-gray-500 focus:border-gray-300 focus:ring-2 focus:ring-gray-300 placeholder-gray-300" 
              rows="4" 
              placeholder="{{ comment_ph }}" 
              data-testid="comment-text"></textarea>
            {% for error in comment_form.text.errors %}
              <span class="text-red-400 text-sm" data-testid="comment-error">{{ error }}</span>
            {% endfor %}
          </div>
          <div class="flex justify-end">
            <button type="submit" 
                    class="btn btn-sm bg-gray-200 text-gray-700 border-none rounded-lg shadow-md hover:bg-gray-300 hover:shadow-lg transition-all duration-200 px-5" 
                    data-testid="comment-submit">
              {% trans "+ Add comment" %}
            </button>
          </div>
        </form>
      {% else %}
        <p class="text-gray-400 text-xs">{% trans "Only assignees and admins can add comments." %}</p>
      {% endif %}
    {% else %}
      <p class="text-gray-400 text-xs">
        {% trans "You must" %} 
        <a href="{% url 'login' %}" class="text-blue-500 underline hover:text-blue-700">{% trans "log in" %}</a> 
        {% trans "to add a comment." %}
      </p>
    {% endif %}
  </div>
</div>
